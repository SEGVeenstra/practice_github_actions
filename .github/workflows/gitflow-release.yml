name: GitFlow Release
on:
    pull_request:
        branches:
            - 'develop'
        types:
            - closed

jobs:
    print_info:
        runs-on: ubuntu-latest
        steps:
            - run: |
                echo HEAD_REF: ${{ github.head_ref }}
                echo HEAD starts with 'release/': ${{ startsWith(github.head_ref, 'release/') }}
                echo Merged: ${{ github.event.pull_request.merged }}
                echo should run: ${{ startsWith(github.head_ref, 'releases/') && github.event.pull_request.merged }}
                echo REPOSITORY URL: ${{ github.repositoryUrl }}
    if_merged:
        if: startsWith(github.head_ref, 'release/') && github.event.pull_request.merged
        runs-on: ubuntu-latest
        steps:
            - name: Is release PR check
              run: |
                echo A 'release' PR has been merged: ${{ github.head_ref }}

            - name: Checkout
              uses: actions/checkout@v3
              with:
                ref: master

            - name: Merge to master
              uses: bambamboole/gha-upmerge@main
              with:
                to_branch: 'master'
                from_branch: ${{ github.head_ref }}
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - run: |
                version=$(basename ${{ github.head_ref }})
                echo ${version}
                git clone --branch ${{ github.head_ref }} ${{ github.repositoryUrl }}
                git checkout master
                git merge --squash ${{ github.head_ref }}
                git tag ${version}
                git push
                git push --tags